<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher,APT Threat Hunting Expert | Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher,APT Threat Hunting Expert</title><meta name="author" content="cc"><meta name="copyright" content="cc"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="title: c2开发-bof功能 关于c2开发研究bof功能开发COFF 文件的结构：文件头（COFF_HEADER）：Machine：目标机器类型（如 AMD64、I386）NumberOfSections：节数量PointerToSymbolTable：符号表偏移NumberOfSymbols：符号数量 节表（COFF_SECTION）：Name：节名（如 .text、.data）SizeO">
<meta property="og:type" content="article">
<meta property="og:title" content="Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher,APT Threat Hunting Expert">
<meta property="og:url" content="http://example.com/2025/09/01/bof%E5%8A%9F%E8%83%BD/index.html">
<meta property="og:site_name" content="Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher,APT Threat Hunting Expert">
<meta property="og:description" content="title: c2开发-bof功能 关于c2开发研究bof功能开发COFF 文件的结构：文件头（COFF_HEADER）：Machine：目标机器类型（如 AMD64、I386）NumberOfSections：节数量PointerToSymbolTable：符号表偏移NumberOfSymbols：符号数量 节表（COFF_SECTION）：Name：节名（如 .text、.data）SizeO">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/123.png">
<meta property="article:published_time" content="2025-08-31T16:32:48.108Z">
<meta property="article:modified_time" content="2025-08-31T16:32:31.645Z">
<meta property="article:author" content="cc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/123.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "",
  "url": "http://example.com/2025/09/01/bof%E5%8A%9F%E8%83%BD/",
  "image": "http://example.com/img/123.png",
  "datePublished": "2025-08-31T16:32:48.108Z",
  "dateModified": "2025-08-31T16:32:31.645Z",
  "author": [
    {
      "@type": "Person",
      "name": "cc",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/123.png"><link rel="canonical" href="http://example.com/2025/09/01/bof%E5%8A%9F%E8%83%BD/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher,APT Threat Hunting Expert',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher,APT Threat Hunting Expert</span></a><a class="nav-page-title" href="/"><span class="site-name">Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher,APT Threat Hunting Expert</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">无标题<a class="post-edit-link" href="https://github.com/chao112122_posts/bof功能.md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-31T16:32:48.108Z" title="发表于 2025-09-01 00:32:48">2025-09-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-31T16:32:31.645Z" title="更新于 2025-09-01 00:32:31">2025-09-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>title: c2开发-bof功能</p>
<h1 id="关于c2开发研究"><a href="#关于c2开发研究" class="headerlink" title="关于c2开发研究"></a>关于c2开发研究</h1><h2 id="bof功能开发"><a href="#bof功能开发" class="headerlink" title="bof功能开发"></a>bof功能开发</h2><h3 id="COFF-文件的结构："><a href="#COFF-文件的结构：" class="headerlink" title="COFF 文件的结构："></a>COFF 文件的结构：</h3><p><em>文件头（COFF_HEADER）：</em><br><em>Machine：目标机器类型（如 AMD64、I386）</em><br><em>NumberOfSections：节数量</em><br><em>PointerToSymbolTable：符号表偏移</em><br><em>NumberOfSymbols：符号数量</em></p>
<p><em>节表（COFF_SECTION）：</em><br><em>Name：节名（如 .text、.data）</em><br><em>SizeOfRawData：节数据大小</em><br><em>PointerToRawData：节数据在文件中的偏移</em><br><em>PointerToRelocations：重定位表偏移</em><br><em>NumberOfRelocations：重定位条目数</em></p>
<p><em>符号表（COFF_SYMBOL）：</em><br><em>Name：符号名（如 go 函数）</em><br><em>Value：符号在节中的偏移</em><br><em>SectionNumber：所在节编号</em></p>
<p><em>重定位表（COFF_RELOCATION）：</em><br><em>VirtualAddress：需要修复的地址</em><br><em>SymbolTableIndex：引用的符号索引</em><br><em>Type：重定位类型（如绝对地址）</em></p>
<p><em>COFF 符号名称有两种存储方式：</em></p>
<p><em>短名称（8 字节以内）：直接存储在符号表的 Name 字段（char Name[8]）</em><br><em>长名称：存储在字符串表中，符号表的 Name 字段前 4 字节为 0，后 4 字节是字符串表偏移量。</em></p>
<h3 id="bof在c2的文件结构"><a href="#bof在c2的文件结构" class="headerlink" title="bof在c2的文件结构:"></a>bof在c2的文件结构:</h3><p><img src="C:\Users\超、\AppData\Roaming\Typora\typora-user-images\image-20250831235356315.png" alt="image-20250831235356315"></p>
<h3 id="bof原理"><a href="#bof原理" class="headerlink" title="bof原理:"></a>bof原理:</h3><p><em>bof的原理是在内存中执行 为.o格式 本身是exe未链接的文件状态 后被cs大力开发为c2的武器化功能 用于规避edr的检测 原先执行命令时通过创建进程执行 容易被edr检测 bof的形式是在beacon中执行 不会创建进程 本身体积小</em> </p>
<h3 id="bof主要代码实现"><a href="#bof主要代码实现" class="headerlink" title="bof主要代码实现:"></a>bof主要代码实现:</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span>* <span class="title function_">bof_run</span><span class="params">(<span class="type">char</span>* bof_func,<span class="type">char</span>* bof_path)</span> &#123;</span><br><span class="line">DWORD coffSize = <span class="number">0</span>;</span><br><span class="line"><span class="type">char</span>* buf = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">char</span>* outdata = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> outdataSize = <span class="number">0</span>;</span><br><span class="line">buf = readfile(bof_path, &amp;coffSize);  <span class="comment">//将obj读入缓冲区</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;bof文件大小为%lu\n&quot;</span>, coffSize);</span><br><span class="line"><span class="keyword">if</span> (buf == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cannot readfile\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Arg arg1;</span><br><span class="line"><span class="type">short</span> testNum = <span class="number">8</span>;</span><br><span class="line">arg1.value = (<span class="type">char</span>*)&amp;testNum;</span><br><span class="line">arg1.size = <span class="keyword">sizeof</span>(<span class="type">short</span>);</span><br><span class="line">arg1.includeSize = FALSE;</span><br><span class="line"></span><br><span class="line">Arg args[<span class="number">1</span>] = &#123; arg1 &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* argumentsString = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">size_t</span> argumentsSize = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;准备初始化参数\n&quot;</span>);</span><br><span class="line">PackData(args, <span class="number">1</span>, &amp;argumentsString, &amp;argumentsSize);<span class="comment">//打包参数</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;准备运行bof\n&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (RunCOFF(buf, &amp;coffSize, bof_func, argumentsString, argumentsSize)) &#123;<span class="comment">//执行bof代码</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n[+] SUCCESS - Executed COFF File\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n[+] failed - Executed COFF File\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">outdata = BeaconGetOutputData(&amp;outdataSize);<span class="comment">//输出回显</span></span><br><span class="line"><span class="keyword">if</span> (outdata != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> outdata;</span><br><span class="line">    <span class="comment">//printf(&quot;\n[+] Outdata Below:\n\n%s\n&quot;, outdata);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n[+] failed - not outdata\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">RunCOFF</span><span class="params">(<span class="type">char</span>* FileData, DWORD* DataSize, <span class="type">char</span>* EntryName, <span class="type">char</span>* argumentdata, <span class="type">unsigned</span> <span class="type">long</span> argumentsize)</span> &#123; <span class="comment">//bof解析的主逻辑</span></span><br><span class="line">COFF_t COFF;</span><br><span class="line">COFF.FileBase = FileData;</span><br><span class="line">COFF.FileHeader = (FileHeader_t*)COFF.FileBase; <span class="comment">//文件头</span></span><br><span class="line">COFF.SymbolTable = (Symbol_t*)(COFF.FileBase + COFF.FileHeader-&gt;PointerToSymbolTable);<span class="comment">//文件头＋符号表偏移得到符号表位置</span></span><br><span class="line">COFF.FunctionMappingCount = <span class="number">0</span>;</span><br><span class="line">COFF.RelocationsCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* functionMapping = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">void</span>** sectionMapped = (<span class="type">void</span>**)<span class="built_in">calloc</span>(<span class="keyword">sizeof</span>(<span class="type">char</span>*) * (COFF.FileHeader-&gt;NumberOfSections + <span class="number">1</span>), <span class="number">1</span>);;<span class="comment">//分配节区内存</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="type">int</span>)COFF.FileHeader-&gt;Machine != IMAGE_FILE_MACHINE_AMD64) &#123;<span class="comment">//检查符合架构标准</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;文件格式不符合\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(FileData);</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (byte i = <span class="number">0</span>; i &lt; COFF.FileHeader-&gt;NumberOfSections; i++) &#123;</span><br><span class="line">    Section_t* section = (Section_t*)(COFF.FileBase + <span class="keyword">sizeof</span>(FileHeader_t) + (i * <span class="keyword">sizeof</span>(Section_t)));</span><br><span class="line">    <span class="comment">//通过raw加上文件头加上第i块节区获得指定节区位置</span></span><br><span class="line">    sectionMapped[i] = (<span class="type">char</span>*)VirtualAlloc(<span class="literal">NULL</span>, section-&gt;SizeOfRawData, MEM_COMMIT | MEM_RESERVE | MEM_TOP_DOWN, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    </span><br><span class="line">   <span class="keyword">if</span> (section-&gt;PointerToRawData != <span class="number">0</span>) &#123;<span class="comment">//节区数据不为0 将其复制到sectionMapped</span></span><br><span class="line">        <span class="built_in">memcpy</span>(sectionMapped[i], COFF.FileBase + section-&gt;PointerToRawData, section-&gt;SizeOfRawData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">//数据为0内存清0</span></span><br><span class="line">        <span class="built_in">memset</span>(sectionMapped[i], <span class="number">0</span>, section-&gt;SizeOfRawData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//找到代码段复制到RawTextData bof的主要结构 用于执行函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(section-&gt;Name, <span class="string">&quot;.text&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        COFF.RawTextData = sectionMapped[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获得重定位数目</span></span><br><span class="line">    COFF.RelocationsCount += section-&gt;NumberOfRelocations;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">functionMapping = (<span class="type">char</span>*)VirtualAlloc(<span class="literal">NULL</span>, COFF.RelocationsCount * <span class="number">8</span>, MEM_COMMIT | MEM_RESERVE | MEM_TOP_DOWN, PAGE_EXECUTE_READWRITE);</span><br><span class="line"><span class="type">int</span> currentSection = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> s = <span class="number">0</span>; s &lt; COFF.FileHeader-&gt;NumberOfSections; s++) &#123;<span class="comment">//处理重定位</span></span><br><span class="line">    Section_t* section = (Section_t*)(COFF.FileBase + <span class="keyword">sizeof</span>(FileHeader_t) + (s * <span class="keyword">sizeof</span>(Section_t)));</span><br><span class="line">    COFF.RelocationsTextPTR = COFF.FileBase + section-&gt;PointerToRelocations;</span><br><span class="line">    <span class="comment">//获得重定位表起始位置</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; section-&gt;NumberOfRelocations; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">uint32_t</span> symbolOffset = <span class="number">0</span>;</span><br><span class="line">        <span class="type">void</span>* funcptrlocation = <span class="literal">NULL</span>;</span><br><span class="line">        COFF.Relocation = (Relocation_t*)(COFF.RelocationsTextPTR + (i * <span class="keyword">sizeof</span>(Relocation_t)));</span><br><span class="line">        <span class="comment">//获得第i个重定位表起始位置</span></span><br><span class="line">        symbolOffset = COFF.SymbolTable[COFF.Relocation-&gt;SymbolTableIndex].first.value[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">//获取符号表的偏移 为了两个 大于8字节(长)和小于8字节(短) </span></span><br><span class="line">        <span class="keyword">if</span> (COFF.SymbolTable[COFF.Relocation-&gt;SymbolTableIndex].first.Name[<span class="number">0</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//短的</span></span><br><span class="line">            RelocationTypeParse(&amp;COFF, sectionMapped, s, FALSE, <span class="literal">NULL</span>, <span class="literal">NULL</span>);<span class="comment">//重定位表解析</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//长的</span></span><br><span class="line">            BOOL internalFunctionCheck = FALSE;</span><br><span class="line">            funcptrlocation = ProcessBeaconSymbols(((<span class="type">char</span>*)(COFF.SymbolTable + COFF.FileHeader-                         &gt;NumberOfSymbols)) + symbolOffset, &amp;internalFunctionCheck);</span><br><span class="line">            <span class="comment">//解析外部引入函数</span></span><br><span class="line">            <span class="keyword">if</span> (funcptrlocation == <span class="literal">NULL</span> &amp;&amp; COFF.SymbolTable[COFF.Relocation-&gt;SymbolTableIndex].SectionNumber                 == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            RelocationTypeParse(&amp;COFF, sectionMapped, s, &amp;internalFunctionCheck, funcptrlocation,                      functionMapping);<span class="comment">//重定位表解析</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ExecuteEntry(&amp;COFF, EntryName, argumentdata, argumentsize);</span><br><span class="line"><span class="comment">//找到go函数位置执行</span></span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">cc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/09/01/bof%E5%8A%9F%E8%83%BD/">http://example.com/2025/09/01/bof%E5%8A%9F%E8%83%BD/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher,APT Threat Hunting Expert</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/123.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/08/29/c2%E7%A0%94%E7%A9%B6/" title="关于c2开发研究"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">关于c2开发研究</div></div><div class="info-2"><div class="info-item-1">关于c2开发研究c2功能开发1.内存混淆 防止内存扫描 采用rop和定时器去执行 可以做到内存混淆 混淆的区域任意 目前只加密节区 从text到roloc段 一般roloc是最后一个段2.键盘监听器 注册事件监听当键盘按下 用setwindowhook函数hook 自写函数解析出按下记录 目前与内存混淆有冲突还未解决 因为 内存混淆一直在不断混淆 会打乱监听器代码???maybe (可以 但是有bug 似乎和内存混淆冲突 可能考虑注入到系统进程 但是操作危险)3.shellcode注入模块 首先考虑shellcode注入 如果要更sec一点 后续可以用syscall调用 目前存在问题 注入进程后进程容易奔溃? 以及网络通信似乎无法持久化 不过我看其他项目的c2并不是创建进程而是直接调用 这个似乎也与我的内存混淆冲突 不知道cs是怎么解决的4.剪贴板窃取 这个算是一个比较简单的模块 实现一半 bug太多 也不好用 长期窃取十分耗资源5.etw bypass 使用etw的系列函数不断给etw大量无用etw日志6.高级反沙箱 不采用传统的抗沙箱手法 例如使用user和kernel中间的...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/123.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">cc</div><div class="author-info-description">redteam</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/chao112122"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Ec2%E5%BC%80%E5%8F%91%E7%A0%94%E7%A9%B6"><span class="toc-number">1.</span> <span class="toc-text">关于c2开发研究</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#bof%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="toc-number">1.1.</span> <span class="toc-text">bof功能开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#COFF-%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%93%E6%9E%84%EF%BC%9A"><span class="toc-number">1.1.1.</span> <span class="toc-text">COFF 文件的结构：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bof%E5%9C%A8c2%E7%9A%84%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">bof在c2的文件结构:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bof%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.3.</span> <span class="toc-text">bof原理:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bof%E4%B8%BB%E8%A6%81%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.4.</span> <span class="toc-text">bof主要代码实现:</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/01/bof%E5%8A%9F%E8%83%BD/" title="无标题">无标题</a><time datetime="2025-08-31T16:32:48.108Z" title="发表于 2025-09-01 00:32:48">2025-09-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/29/c2%E7%A0%94%E7%A9%B6/" title="关于c2开发研究">关于c2开发研究</a><time datetime="2025-08-29T12:58:25.929Z" title="发表于 2025-08-29 20:58:25">2025-08-29</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By cc</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>